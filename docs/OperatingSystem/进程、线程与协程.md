# 进程、线程与协程

进程是操作系统进行资源分配的基本单位，每个进程都有自己的独立内存空间。由于进程比较重量，占据独立的内存，所以上下文进程间的切换开销（栈、寄存器、虚拟内存、文件句柄等）比较大，但相对比较稳定安全。

线程又叫做轻量级进程，是进程的一个实体，是处理器任务调度和执行的基本单位。它是比进程更小的能独立运行的基本单位。线程只拥有一点在运行中必不可少的资源（如程序计数器，一组寄存器和栈)，但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源。

协程是一种用户态的轻量级线程，也称微线程，协程的调度完全由用户控制（也就是在用户态执行）。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到线程的堆区，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快。你可以把它理解为可以暂停的函数。

## 进程与线程

每个线程都是一个轻量级进程（Light Weight Process），都有自己的唯一 PID 和一个 TGID（Thread group ID）。TGID 是启动整个进程的 thread 的 PID。

例如，当一个进程被创建的时候，它其实是一个 PID 和 TGID 数值相同线程。当线程 A 启动线程 B 时，线程 B 会有自己的唯一 PID，但它的 TGID 会从 A 继承而来。这样通过 PID 线程可以独立得到调度，而相同的 TGID 可以知道哪些线程属于同一个进程，这样可以共享资源（RAM，虚拟内存、文件等）。

- 根本区别：进程是操作系统资源分配的基本单位，而线程是处理器任务调度和执行的基本单位。
- 资源开销：每个进程都有独立的代码和数据空间，程序之间的切换会有较大的开销；线程可以看做轻量级的进程，同一进程的线程共享代码和数据空间，每个线程都有自己独立的运行栈和程序计数器，线程之间切换的开销小。
- 包含关系：如果一个进程内有多个线程，则执行过程不是一条线的，而是多条线（线程）共同完成的。
- 内存分配：同一进程的线程共享本进程的地址空间和资源；而进程之间的地址空间和资源是相互独立的。
- 影响关系：一个进程崩溃后，在保护模式下不会对其他进程产生影响；但是一个线程崩溃整个进程都死掉。所以多进程要比多线程健壮。
- 执行过程：每个独立的进程有程序运行的入口、顺序执行序列和程序出口；但是线程不能独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。两者均可并发执行。

## 线程与协程

- 一个线程可以有多个协程。
- 大多数业务场景下，线程进程可以看做是同步机制，而协程则是异步。
- 线程是抢占式，而协程是非抢占式的，所以需要用户代码释放使用权来切换到其他协程，因此同一时间其实只有一个协程拥有运行权，相当于单线程的能力。
- 协程并不是取代线程，而且抽象于线程之上。线程是被分割的 CPU 资源, 协程是组织好的代码流程, 协程需要线程来承载运行。

## 进程间通信方式

由于每个进程的资源相互不可见，因此进程间要交换数据必须通过内核，在内核中开辟一块缓冲区，用于进程间通信（**IPC**，InterProcess Communication）。IPC 的主要方式包括：

- 管道，通常指无名管道。管道是一种半双工通信方式，并且只能在父子或者兄弟进程中使用；
- 命名管道，同样是半双工通信。多个进程可以通过一个约定好的名字找到同一个管道；
- 消息队列，消息队列是消息的链表，存放在内核中并由消息队列标识符标识。消息队列克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点。容量受到系统限制，且要注意第一次读的时候，要考虑上一次没有读完数据的问题
- 共享内存，就是映射一段能被其他进程所访问的内存，这段共享内存由一个进程创建，但多个进程都可以访问。共享内存是最快的IPC方式，不用从用户态到内核态频繁的切换和拷贝数据。
- 信号量，一个计数器，可以用来控制多个进程对共享资源的访问。它常作为一种锁机制，防止某进程正在访问共享资源时，其他进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段（PV 操作）。
- 信号，是软中断产生，用于进程间异步传递信息。信号可以用来直接进行用户空间进程和内核进程之间的交互，内核进程也可以利用它来通知用户空间进程发生了哪些系统事件。
- 套接字，与其他通信机制不同的是，套接字允许两个进程进行通讯，这两个进程可能运行在同一个机器上，也可能运行在不同机器上。相对于共享内存可以多对多的读取与写入，套接字只能一对一。此外由于序列化等操作占用大量资源，相对于共享内存，套接字更适合传输少量数据。