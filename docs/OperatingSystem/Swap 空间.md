# Swap 空间

Linux 在管理物理内存时将 DRAM 划分为一个个内存块（chunks of memory），这些内存块称之为 *页* Page。Linux 管理物理内存的基本单位是「页」。

## 1. Swap 简介

Swap 是将内存页复制到硬盘上的「预配置空间」（称为 *交换空间*）来释放内存页的过程。物理内存和交换空间的组合大小就是可用的「虚拟内存」量。那为什么需要交换？

- 当系统需要的内存多于物理可用的内存时，内核会「置换」较少使用的页面，并给内存提供当前需要内存的应用进程；
- 应用程序在启动阶段使用大量页面可能仅用于初始化，然后再也不会使用，系统可以换出这些页面并为其他应用程序释放内存

但是，swap 也有缺点，因此与内存相比，磁盘的访存非常慢。<mark>发生交换的越多，系统就会越慢</mark>。当页面被频繁地换出换入，会发生过度交换或抖动。

Linux 有两种形式的交换空间：

- 交换分区：是硬盘的独立分区，专门用于交换并且不会有文件驻留；
- 交换文件：文件系统的特殊文件，位于系统文件和数据文件之间

### 查看交换空间的信息

如果要查看交换空间的相关信息，可以使用 `swapon -s`：

```shell
Filename   Type            Size    Used    Priority
/dev/sda3  partition       999420  0       -2
```

- Type：表示当前的交换空间是一个「分区」Partition 还是「文件」File；
- Filename：交换空间的目录，当前在 ‘dev/sda3’ 分区；
- Size：以 KB 为单位；
- Used：表示当前使用多少 KB 的交换空间；
- Priority：告诉内核首先使用哪个交换空间

Linux 交换子系统的一大优点是，如果以相同的优先级挂载两个或更多交换空间（最好在不同设备），Linux 将在它们之间交错其交换活动，从而提升交换性能。

### 添加新交换分区

要将额外的交换分区添加到系统中，首先要确保分区被标记为交换分区，然后是制作交换文件系统。应该使用 `fdisk -l /dev/sdx` 来查看分区标记。

如果分区为标记为交换分区，则需要使用 `fdisk -t` 来修改它。但是需要注意的是，<mark>一旦你将分区更改为交换分区，则交换分区上的所有数据都将丢失</mark>。因此在进行更改前，一定要仔细检查所做的每项更改。当分区被标记为交换区，你需要使用 `mkswap /dev/sdx` 准备它。如果没有出现错误，说明该交换空间可用。要激活它，使用 `swapon /dev/sdx` 命令。你可以使用 `swapon -s` 验证它是否正在被使用。

如果你想在启动时自动挂载交换分区，则必须向 /etc/fstab 文件添加一个条目，包含启动时挂在的文件系统和交换空间列表，由于交换空间是一种棵树的文件系统，其中许多参数不适用，因此尝试：

```
/dev/sdx	none swap sw 0 0
```

`/dev/sdx` 是要挂载的分区；由于没有特定的挂载点，因此第二个参数是 none；swap 代表是交换类型；sw 表示带有 sw 选项，最后两个参数不使用因此置 0。

要检查交换空间是否自动挂载，你可以先 `swapoff -a` 关闭所有交换空间；然后执行 `swapon -a` 挂载 /etc/fstab 文件中列出的所有交换空间；然后使用 `swapon -a` 检查所有交换空间。

### 交换文件

你可以用类似的方法创建、准备和挂载「交换文件」。交换文件的优点是**不需要找到一个空的分区或者重新分区磁盘来添加额外的交换空间**。要创建一个交换文件，使用 dd 命令创建一个空文件。假设要创建 1GB 文件，可以使用：

```shell
dd if=/dev/zero of=/swapfile bs=1M count=1024
```

其中 /swapfile 是交换文件的文件名；bs（block size）指一个分块的大小；count 是分块的数量。然后准备交换文件和挂载的命令与「交换分区」的相同。

### 交换空间应该有多大

你可以在没有交换空间的情况下运行 Linux，但是当你用完物理内存时，系统将崩溃。通常对于交换空间的大小配置可以遵从以下经验法则：

1. 对于桌面系统，使用**两倍内存**的交换空间，因为它可以让你运行大量的应用程序（其中许多可能是空闲的并且很容易交换），使得更多 RAM 可用于活动应用程序；
2. 对于服务器，有较少的可用交换空间（比如物理内存的一半），以便您在需要时可以灵活地进行交换，但要监控使用的交换空间量并在必要时升级您的 RAM；
3. 对于较旧的台式机（比如只有 128MB），使用尽可能多的交换空间

## 2. Swappiness

通常我们说，当内存不够用的时候回用到 swap 分区，但问题是如何区分当前内存不够用。<mark>不是物理内存完全用完才叫不够用，具体如何开始使用交换空间由 swappiness 参数决定</mark>。

### swappiness 理解

swappiness 可以设置 0-100 的值。swappiness 代表了使用交换空间的程度。

- swappiness=0：最大限度使用物理内存，然后才使用交换空间；
- swappiness=100：积极地使用交换空间，且及时将内存中的数据置换到交换空间中

Linux 默认设置通常为 60，即当内存使用达到 40%（100-60）时就开始使用交换空间。但是，假设一个 16G 内存的计算机，在使用了大约 6G 内存后就开始使用交换空间，不断进行磁盘 IO，这可能严重影响系统性能。

最后给出对于 Github 上的权威解释：

> 这个参数用于定义内核交换内存页的攻击性。较高的值会增加攻击性，较低的值会减少交换量。当设置为 0 表示内核在空闲页和文件备份页的数量小于区域中的高水位线之前不启动交换。

### swappiness 名称来源

Linux2.6 内核添加了该内核参数，使管理员可以调整 Linux 交换方式。

> 本质上，较高的值会导致更多的页面被交换，而较低的值会导致更多的应用程序保留在内存中，即使它们处于空闲状态。

### swappiness 值操作

可以使用 `cat /proc/sys/vm/swappiness` 查看当前 swappiness 的值。或者，你可以使用 `sysctl vm.swappiness` 查看。

你可以使用 `sysctl vm.swappiness=10` 或者 `echo 10 > /proc/sys/vm/swappiness` 命令将 swappiness 临时修改为 10。

如果你想永久修改，那么需要修改 /etc/sysctl.conf 修改：

```shell
cat /etc/sysctl.conf
# 添加下列内容
vm.swappiness=10
```

然后通过 `sysctl -p` 激活设置。

## 参考

[Linux 中的 Swap与swappiness](https://zhuanlan.zhihu.com/p/444321207)