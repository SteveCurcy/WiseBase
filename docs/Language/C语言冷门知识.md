# Cè¯­è¨€å†·é—¨çŸ¥è¯†

## 1. __attribute__

å…·ä½“è¯·å‚è§[å®˜æ–¹æ–‡æ¡£](https://gcc.gnu.org/onlinedocs/gcc-4.7.2/gcc/Function-Attributes.html)ã€‚ğŸ‘

è¿™é‡Œè¿˜æ˜¯å»ºè®®çœ‹å®˜æ–¹æ–‡æ¡£è€Œä¸æ˜¯ç½‘ç»œæœç´¢ï¼Œå› ä¸ºæ¯ä¸ªäººçš„ç¿»è¯‘æ°´å¹³æœ‰é™ï¼Œå¾ˆå¯èƒ½äº§ç”Ÿæ­§ä¹‰ï¼Œå¯¼è‡´æ›´å¤šçš„é”™è¯¯ã€‚

`__attribute__` æ˜¯ GNU C ç‰¹è‰²ä¹‹ä¸€ï¼Œåœ¨ç³»ç»Ÿä¸­éšå¤„å¯è§ã€‚å®ƒå¯ä»¥è®¾ç½®å‡½æ•°å±æ€§ï¼Œå˜é‡å±æ€§å’Œç±»å‹å±æ€§ã€‚

- å‡½æ•°å±æ€§ï¼š`noreturn, noinline, always_inline, pure, const, nothrow, sentinel, format, format_arg, no_instrument_function, section, constructor, destructor, used, unused, deprecated, weak, malloc, alias, warn_unused_result, nonnull`
- ç±»å‹å±æ€§ï¼š`aligned, packed, transparent_union, unused, deprecated, may_alias`
- å˜é‡å±æ€§ï¼š`aligned, packed`

å±æ€§çš„ä¹¦å†™æ ¼å¼ä¸º `__attribute__((xxx))`ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¿™äº›å±æ€§å…³é”®å­—å‰åæ·»åŠ ä¸‹åˆ’çº¿ï¼Œæ¥é˜²æ­¢å¤´æ–‡ä»¶ä¸­å­˜åœ¨åŒåçš„å®å¯¼è‡´çš„é”™è¯¯ï¼Œå¦‚ï¼š`__attribute__((__xxx__))`ã€‚

è¿™äº›å±æ€§å°†å½±å“ç¼–è¯‘å™¨çš„è¡Œä¸ºï¼Œå‘ŠçŸ¥ç¼–è¯‘å™¨å®ƒåº”è¯¥å¦‚ä½•ç¼–è¯‘ç¨‹åºã€‚

### 1.1. format

`__attribute__((format(archetype, string-index, first-to-check)))`

format å±æ€§å¯ä»¥ç»™è¢«å£°æ˜çš„å‡½æ•°åŠ ä¸Šç±»ä¼¼ `printf` å’Œ `scanf` çš„ç‰¹å¾ï¼Œä½¿ç¼–è¯‘å™¨æ£€æŸ¥å‡½æ•°å£°æ˜å’Œå®é™…è°ƒç”¨å‚æ•°ä¹‹é—´çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…ã€‚

- `archetype`ï¼šåªèƒ½å¡«å…¥ `printf` æˆ– `scanf`ï¼ŒæŒ‡å®šæŒ‰ç…§å“ªç§æ–¹å¼æ¥æ£€æµ‹å‚æ•°ï¼›
- `string-index`ï¼šè¯´æ˜æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ç¬¬å‡ ä¸ªå‚æ•°ï¼›
- `first-to-check`ï¼šæŒ‡å®šç¬¬ä¸€ä¸ªç”¨äºæ ¼å¼åŒ–å¯å˜å‚æ•°æ˜¯ä¼ å…¥çš„ç¬¬å‡ ä¸ªå‚æ•°

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœå‡½æ•°æ˜¯ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œé‚£ä¹ˆä»–è¿˜ä¼šä¼ å…¥ä¸€ä¸ªéšè—çš„ `this` æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™æ—¶ï¼Œéœ€è¦æ³¨æ„æŒ‡å®šçš„å‚æ•°ä½ç½®æ˜¯å¦æ­£ç¡®ï¼

```cpp
extern void log(const char *fmt, ...) __attribute__((__format__(printf, 1, 2)));

log("integer: %d\n", 0);
log("string: %s\n", "abc");
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œå±æ€§å‘ŠçŸ¥ç¼–è¯‘å™¨ï¼Œæ£€æŸ¥ä»å‡½æ•° `log` ç¬¬ 2 å‚æ•°å¼€å§‹çš„å‚æ•°æ˜¯å¦èƒ½ä¾æ¬¡æ ¼å¼åŒ–åˆ°ç¬¬ 1 ä¸ªå‚æ•°æŒ‡å®šçš„å­—ç¬¦ä¸²ä¸­ã€‚

### 1.2. noreturn

è¯¥å±æ€§å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå‡½æ•°æ°¸è¿œä¸ä¼š returnï¼Œè€Œæ˜¯é€€å‡ºç¨‹åºã€‚åœ¨ä½¿ç”¨è¯¥å±æ€§æ—¶ï¼Œå»ºè®®å¼€å¯ `-O2` ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†è¯¥å‡½æ•°çš„ return è¯­å¥å¿½ç•¥ï¼Œå¹¶ä¸”ç›´æ¥é€€å‡ºã€‚è¯¥å‡½æ•°ä¹‹åçš„æ‰€æœ‰ä»£ç éƒ½ä¼šè¢«ä¼˜åŒ–æ‰ï¼ˆå¿½ç•¥ï¼‰ã€‚

é€šçŸ¥ç¼–è¯‘å™¨è¯¥å‡½æ•°æ°¸ä¸è¿”å›ï¼ˆå³é€€å‡ºç¨‹åºï¼‰ï¼Œåªèƒ½ç”¨æ¥ä¿®é¥°å‡½æ•°çš„å£°æ˜ï¼›å¦‚æœä¿®é¥°å‡½æ•°çš„å®šä¹‰ï¼Œåˆ™ä¼šå¯¼è‡´ Clang å‘Šè­¦å’Œ GCC æŠ¥é”™ã€‚

å¦‚æœä½ ä½¿ç”¨è¿™ä¸ªå±æ€§ä¿®é¥°æŸä¸€ä¸ªå‡½æ•°ï¼Œè¯·è®°å¾—åœ¨å‡½æ•°å‡ºå£ä½¿ç”¨ `exit` ä¿è¯ç¨‹åºçš„æ­£ç¡®é€€å‡ºï¼›å¦åˆ™ä¸ä»…ä¼šå¯¼è‡´ç¼–è¯‘å™¨çš„è­¦å‘Šï¼ŒClang ç¼–è¯‘çš„ç¨‹åºè¿˜ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„æƒ…å†µã€‚

ä¸‹é¢ç»™å‡ºå®˜æ–¹çš„ä¾‹å­ï¼š

```cpp
void fatal () __attribute__ ((__noreturn__));
          
void fatal (/* ... */) {
  /* ... */ /* Print error message. */ /* ... */
  exit (1);
}
```

### 1.3.  packed

è¯¥å±æ€§æŒ‡å®šä¸€ä¸ªå˜é‡æˆ–ç»“æ„ä½“çš„æŸä¸ªå­—æ®µåº”è¯¥æŒ‰ç…§å°½å¯èƒ½å°çš„å¯¹é½æ–¹å¼ï¼Œé™¤éä½¿ç”¨ aligned å±æ€§æŒ‡å®šäº†æ›´å¤§çš„å€¼ã€‚æ‰€ä»¥ï¼Œpacked å±æ€§å¯ä»¥è¾¾åˆ°è®©è¯¥å˜é‡ã€ç»“æ„ä½“æˆ–ç»“æ„ä½“å­—æ®µä¸è¦å¯¹é½çš„æ•ˆæœã€‚

```cpp
struct __attribute__((__packed__)) packed_struct_t {
    char a;
    int b;
    char c;
};
```

å¦‚ä¸Šç»“æ„ä½“å°†ä¹‹å ç”¨ 6 å­—èŠ‚ï¼›è€Œå¦‚æœä¸ä½¿ç”¨è¯¥å±æ€§ä¿®é¥°ï¼Œåˆ™ç”±äºé»˜è®¤ 4 å­—èŠ‚å¯¹å…¶è€Œå ç”¨ 12 å­—èŠ‚ã€‚

## 2. C è¯­è¨€å®å®šä¹‰

### 2.1. # è¿ç®—ç¬¦

# è¿ç®—ç¬¦å°†å®çš„ä¸€ä¸ªå‚æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²å­—é¢é‡ã€‚å®ƒä»…å…è®¸å‡ºç°åœ¨å¸¦å‚æ•°çš„å®çš„æ›¿ä»£åˆ—è¡¨ä¸­ (# è¿ç®—ç¬¦æ‰€æ‰§è¡Œçš„æ“ä½œå¯ä»¥ç†è§£ä¸ºâ€œå­—ç¬¦ä¸²åŒ–â€)ã€‚# è¿ç®—ç¬¦ä¸åé¢çš„å‚æ•°ä¹‹é—´å¯ä»¥æœ‰ç©ºæ ¼æˆ–ç¼©è¿›ã€‚

é€šå¸¸åœ¨ç¨‹åºçš„è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æ‰“å°å˜é‡çš„å€¼æ¥è§‚å¯Ÿç¨‹åºçš„èµ°å‘ï¼Œå¦‚â€œa = 3â€ç­‰ã€‚é‚£æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™ï¼š

```cpp
#define print_int(n) printf(# n " = %d\n", (n))
```

å½“ä½ è°ƒç”¨ `print_int(i/j)` æ—¶ï¼Œä¼šè¢«é¢„å¤„ç†ä¸º `printf("i/j"" = %d\n", i/j)` ã€‚

### 2.2. ## è¿ç®—ç¬¦

å®ƒå¯ä»¥å°†ä¸¤ä¸ªç¬¦å·â€œç²˜åˆâ€åœ¨ä¸€èµ·ï¼Œæˆä¸ºä¸€ä¸ªç¬¦å·ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªç¬¦å·æ˜¯å®å‚æ•°ï¼Œâ€œç²˜åˆâ€æ“ä½œä¼šåœ¨å‚æ•°å®Œæˆæ›¿æ¢åå‘ç”Ÿã€‚åŒæ ·ï¼Œè®°å·ä¸æ“ä½œç¬¦ä¹‹é—´å¯ä»¥æœ‰ç©ºæ ¼å’Œç¼©è¿›ã€‚

å¦‚ `#define CONCAT(x,y) x ##y`ï¼Œè°ƒç”¨ `CONCAT(a,b)` åˆ™ä¼šå¾—åˆ° abã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ `CONCAT(a,CONCAT(b,c))` åˆ™ä¼šå¾—åˆ°å¥‡æ€ªçš„ç»“æœã€‚

é—®é¢˜åœ¨äº `CONCAT(a,CONCAT(b,c))` ä¸ä¼šæŒ‰ç…§"æ­£å¸¸"çš„æ–¹å¼æ‰©å±• `CONCAT(b,c)` å¾—å‡º bcã€‚ç„¶å `CONCAT(a,bc)` ç»™å‡º abcã€‚åœ¨æ›¿æ¢åˆ—è¡¨ä¸­ï¼Œä½äº ## è¿ç®—ç¬¦ä¹‹å‰å’Œä¹‹åçš„å®å‚æ•°åœ¨æ›¿æ¢æ—¶ä¸è¢«æ‰©å±•ï¼Œå› æ­¤ï¼Œ`CONCAT(a,CONCAT(b,c))` æ‰©å±•ä¸º `aCONCAT(b,c)`ï¼Œè€Œä¸ä¼šè¿›ä¸€æ­¥æ‰©å±•ï¼Œå› ä¸ºæ²¡æœ‰åä¸º `aCONCAT` çš„å®ã€‚

ä½ å¯ä»¥é€šè¿‡å†å®šä¹‰ä¸€ä¸ªå®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š`#define CONCAT2(x,y) CONCAT(x,y)`ã€‚è¿™æ ·è°ƒç”¨ `CONCAT2(a,CONCAT2(b,c))` å°±ä¼šå¾—åˆ° abcã€‚

### 2.3. å®å®šä¹‰å¯å˜å‚æ•°

å®å®šä¹‰ä¹Ÿæ”¯æŒå¯å˜å‚æ•°ï¼Œä½¿ç”¨ `..., __VA_ARGS__` é…åˆå®ç°ï¼Œä¹Ÿå¯ä»¥ç»“åˆå…¶ä»–å®å®šä¹‰ä½¿ç”¨ï¼š

```cpp
#define FOO(a, ...) a##__VA_ARGS__
FOO(1, 2, 3)    // é¢„å¤„ç†ä¸ºï¼š12,3
#define PRINT_SELF(...) #__VA_ARGS__
PRINT_SELF(1, 2, 3)    // é¢„å¤„ç†ä¸º "1, 2, 3"
```

### 2.4.ï¼ˆåµŒå¥—ï¼‰å®å®šä¹‰çš„å±•å¼€é¡ºåº

å®å±•å¼€åªæ˜¯ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ã€‚ä½†æˆ‘ä»¬åœ¨ä½¿ç”¨å®å®šä¹‰çš„æ—¶å€™ä¹Ÿç»å¸¸ä¼šé‡åˆ°åµŒå¥—å±•å¼€ç­‰å¤æ‚çš„æƒ…å†µã€‚å› æ­¤äº†è§£å®å®šä¹‰å±•å¼€çš„é¡ºåºå°¤ä¸ºé‡è¦ï¼š

- ä¸ä¼šé€’å½’å±•å¼€ï¼šå®å®šä¹‰å±•å¼€è™½ç„¶å¯èƒ½éœ€è¦åšå¤šæ¬¡æ›¿æ¢ï¼Œä½†æ˜¯ä¸€å®šä¸ä¼šé€’å½’å±•å¼€ï¼›
- æœ‰å†…è€Œå¤–å±•å¼€ï¼šå…ˆå±•å¼€å†…å±‚å®ï¼Œå†å±•å¼€å¤–å±‚å®ï¼›
- å¦‚æœå®å®šä¹‰ä¸­æŸå‚æ•°å‰æœ‰ # è¿ç®—ç¬¦ï¼Œåˆ™ä¸å±•å¼€å¯¹åº”å‚æ•°ï¼Œè€Œæ˜¯ç›´æ¥å°†è¯¥å‚æ•°è½¬ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼›
- å¦‚æœå®å®šä¹‰ä¸­æŸå‚æ•°å‰/åæœ‰ ## è¿ç®—ç¬¦ï¼Œåˆ™ä¸å±•å¼€å¯¹åº”å‚æ•°ï¼Œè€Œæ˜¯å°† ## è¿ç®—ç¬¦å‰åçš„å‚æ•°è¿æ¥æˆä¸ºä¸€ä¸ªæ–°çš„ç¬¦å·ï¼ˆä¸æ˜¯å­—ç¬¦ä¸²ï¼‰

å› æ­¤ï¼Œå‡å¦‚æˆ‘ä»¬å®šä¹‰äº† `#define f(a) f(2 * (a))` ä½†æ˜¯è°ƒç”¨æ—¶å¯¹åº”çš„å®å®šä¹‰åªä¼šè¢«å±•å¼€ä¸€æ¬¡ã€‚å¦‚ `f(1)` ä¼šè¢«å±•å¼€ä¸º `f(2)`ï¼Œä½†æ˜¯ `f(2)` å¹¶ä¸ä¼šå†æ¬¡è¢«å±•å¼€ï¼Œå› ä¸ºå®ƒå°±æ˜¯è¢« `f(1)` å±•å¼€è¿‡çš„ã€‚

å› æ­¤è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆä½¿ç”¨ ## è¿ç®—ç¬¦æ—¶ï¼ŒåµŒå¥— `CONCAT` å°±ä¼šæŠ¥é”™è€Œæ–°å®šä¹‰ `CONCAT2` è°ƒç”¨ `CONCAT` å†åµŒå¥—å°±ä¸ä¼šæŠ¥é”™ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•å±•å¼€çš„ï¼š

```cpp
#define CONCAT(x, y) x ## y
#define CONCAT2(x, y) CONCAT(x,y)

// ä¸‹é¢å±•ç¤ºäº† CONCAT2(a,CONCAT2(b,c)) åœ¨é¢„å¤„ç†æ—¶è¢«å±•å¼€çš„è¿‡ç¨‹
CONCAT2(a,CONCAT2(b,c))
CONCAT2(a,CONCAT(b,c))
CONCAT2(a, b ## c) => CONCAT2(a, bc)
CONCAT(a, bc)
a ## bc => abc
```

### 2.5. #undef æŒ‡ä»¤ ğŸ”¥

è¯¥æŒ‡ä»¤ç”¨äºå–æ¶ˆä¹‹å‰ä½¿ç”¨ `#define` å®šä¹‰çš„å®ã€‚å¦‚æœæƒ³ä½¿ç”¨ä¸€ä¸ªåç§°ä½†æ˜¯åˆä¸ç¡®å®šä¹‹å‰æ˜¯å¦ç”¨è¿‡ï¼Œä¸ºäº†å®‰å…¨èµ·è§å¯ä»¥å…ˆä½¿ç”¨ `#undef` å–æ¶ˆå®šä¹‰ç„¶åå†å®šä¹‰ã€‚

### 2.6. é¢„å®šä¹‰å®

C99 å¼€å§‹å¼•å…¥ä¸€ä¸ªç‰¹æ®Šæ ‡è¯†ç¬¦ `__func__`ï¼Œè¯¥æ ‡è¯†ç¬¦æ˜¯ä¸€ä¸ªå˜é‡åè€Œéå®å®šä¹‰ï¼Œå› æ­¤ä¸å±äºå®å®šä¹‰çš„èŒƒç•´ï¼Œä½†æ˜¯å®ƒçš„ä½œç”¨å’Œ `__FILE__, __LINE__` ç±»ä¼¼ã€‚

```cpp
#include <stdio.h>

void func() {
    printf("This function is %s\n", __func__);
    printf("This is line %d\n", __LINE__);
}

int main() {
    printf("This file is %s\n", __FILE__);
    printf("This date is %s\n", __DATE__);
    printf("This time is %s\n", __TIME__);
    printf("This function is %s\n", __func__);
    printf("This is line %d\n", __LINE__);
    func();
    return 0;
}
```

### 2.7. æ³›å‹é€‰æ‹©

C11 ä¸­æ–°å¢äº†ä¸€ç§è¡¨è¾¾å¼ï¼Œç§°ä¸º *æ³›å‹é€‰æ‹©è¡¨è¾¾å¼* ï¼Œå¯æ ¹æ®è¡¨è¾¾å¼çš„ç±»å‹é€‰æ‹©ä¸€ä¸ªå€¼ã€‚

`_Generic` æ˜¯ C11 çš„å…³é”®å­—ï¼Œç¬¬ä¸€é¡¹æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåé¢æ¯é¡¹éƒ½ç”±ä¸€ä¸ªç±»å‹ã€ä¸€ä¸ªå†’å·å’Œä¸€ä¸ªå€¼ç»„æˆï¼Œå¦‚ `_Generic(x, int: 0, float: 1, double: 2, default3)` ã€‚å½“ç„¶ï¼Œåé¢çš„å€¼ä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼š

```cpp
#include <stdio.h>

#define TYPE(x) _Generic((x), int: "data is int", float: "data is float", double: "data is double", default: "other")

int main() {
		printf("%s\n", TYPE(1));
    printf("%s\n", TYPE(1.0f));
    printf("%s\n", TYPE(1.0));
    printf("%s\n", TYPE(1l));
    return 0;
}
```